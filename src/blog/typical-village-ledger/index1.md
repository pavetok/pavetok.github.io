---
layout: post.html
title: Распределённый реестр по-деревенски
teaser: >-
  Как бы работал распределённый реестр, если бы его
  организовали жители обычной деревни
cover:
  path: village.png
  cap: Распределённый реестр по-деревенски
date: 2022-02-07
---
{%- import "components/page.html" as page -%}
{%- import "components/section.html" as section -%}

{{ page.cover(cover) }}

Когда необходимо разобраться в новой предметной области или спроектировать новое решение
полезно "приземлить" свои представления на какой-либо понятный "аналоговый" пример из жизни.
Собственно этим мы и займёмся, а именно постараемся предметную область распределенных реестров
приземлить на жизнь обычной деревни.

{{ section.title("Стратегии согласования действий") }}

Будем считать, что жители нашей деревни стремятся к _умиротворённой_ жизни.
Умиротворённость достигается за счёт _согласованности действий_ её жителей.
Несогласованные действия приводят к конфликтам. Поэтому в умиротворённой деревне конфликты
либо _компенсируются_, либо _пресекаются_, либо _предупреждаются_.

Компенсация означает, что любое совершенное действие может быть оспорено и в каком-то виде компенсировано.
Пресечение означает, что действия можно совершать только под чутким контролем _лидера_<sup>1</sup>,
который наращивает вес за допуск хороших действий и теряет - за пропуск плохих.
Предупреждение означает, что действие может быть совершено только с согласия всех жителей деревни.

Таким образом нам доступны следующие стратегии:
1. Компенсация конфликтов
2. Пресечение конфликтов
3. Предупреждение конфликтов

Будем считать, что любое действие предваряется необязательным _согласованием намерения_ и
завершается необязательным _оповещением о событии_. Соотнесём стратегии по этим критериям.

<table>
  <thead>
    <tr>
      <th scope="col"></th>
      <th scope="col">Согласование намерения</th>
      <th scope="col">Оповещение о событии</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th scope="row">Компенсация конфликтов</th>
      <td>Ни с кем</td>
      <td>Всем</td>
    </tr>
    <tr>
      <th scope="row">Пресечение конфликтов</th>
      <td>С лидером</td>
      <td>Всем остальным</td>
    </tr>
    <tr>
      <th scope="row">Предупреждение конфликтов</th>
      <td>Со всеми</td>
      <td>Никому</td>
    </tr>
  </tbody>
  <caption class="caption">
    Соотнесение стратегий согласования действий
  </caption>
</table>

Как видно из таблицы стратегии компенсации и предупреждения по сути противоположны друг другу, а
стратегия пресечения находится где-то посередине. Теперь попробуем разобраться в том,
что нужно для реализации обозначенных стратегий.

{{ section.title("Платформа согласования действий") }}

А нужен нам конечно же распределенный реестр, ключевыми компонентами которого являются:
1. Network по-деревенски
2. Gossip по-деревенски
3. Consensus по-деревенски

**Network по-деревенски**

Как устроен деревенский network? Роль узлов выполняют _избы_. Роль каналов - _дорожки_.
Для отправки сообщения другому узлу необходимо физически отправить _гонца_<sup>2</sup> в другую избу.
Для массовой отправки одного и того же сообщения N узлам требуется N гонцов.
_Сообщение_ можно передать только устно, как следствие, большие сообщения приходится разбивать на части.
Сообщение (или его часть) в процессе доставки может быть потеряно или искажено.
Для повышения надёжности сети проектируются и внедряются различные _протоколы_ сетевого взаимодействия.
В избе может жить одна или несколько _семей_, которые по сути являются пользователями сети.

**Gossip по-деревенски**

ТБД

**Consensus по-деревенски**

ТБД

{{ section.title("Зачем согласовывать действия") }}

С одной стороны жители деревни стремятся к умиротворённой жизни, а с другой они сталкиваются с ограничениями физического мира.
Как следствие, действие улучшающее умиротворённость одного может приводить к ухудшению умиротворённости другого.
Поэтому в идеальной деревне действие одного всегда согласовано со всеми остальными.
Следующее действие не может быть согласовано до тех пор, пока не будет согласовано предыдущее.
Чтобы начать согласование следующего действия все, как минимум, должны узнать о результатах предыдущего.
Согласование ни с кем, с группой (в т.ч. с одним), со всеми.
Согласование по ресурсу, по фонду, по активу.
Согласование в случае недоступности, разногласия, оппортунизма.
Акторы новые, вкалывающие, пожинающие
Согласованность по содержанию, по порядку, по последствиям

---

<sup>1</sup> Чтобы стать лидером, нужно вложиться усилиями (proof of work), вложиться ресурсами (proof of stake) или
вложиться авторитетом (proof of authority).  
<sup>2</sup> Это может быть любой член семьи.  